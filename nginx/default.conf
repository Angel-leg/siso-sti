server {
    listen 80;

    # Proxy para backend API (puerto 3001)
    location /api/ {
        proxy_pass http://backend:3001/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Proxy para plumber API (puerto 8000)
    location /apis/ {
        proxy_pass http://plumber:8000/apis/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Proxy para frontend estático (contenedor frontend expone puerto 80)
    # Primero, las rutas estáticas directas que existan:
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|ttf|woff|woff2|eot|json)$ {
        proxy_pass http://frontend:80;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Finalmente, para todas las demás rutas, enviar al index.html del frontend
    location / {
        proxy_pass http://frontend:80/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # Si quieres, puedes agregar estas líneas para que las rutas SPA funcionen:
        proxy_intercept_errors on;

        # Aquí se usa error_page para que si el frontend responde 404, vuelva a /index.html
        error_page 404 = /index.html;
    }
}
